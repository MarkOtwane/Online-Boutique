<div class="community-container">
  <div class="community-header">
    <h1>Community Hub</h1>
    <p>Connect with other customers, share experiences, and discover new products</p>
  </div>

  <!-- Tab Navigation -->
  <div class="tab-navigation">
    <button
      class="tab-button"
      [class.active]="activeTab === 'community'"
      (click)="onTabChange('community')"
    >
      <i class="fas fa-users"></i> Community Feed
    </button>
    <button
      class="tab-button"
      [class.active]="activeTab === 'chat'"
      (click)="onTabChange('chat')"
    >
      <i class="fas fa-comments"></i> Group Chat
    </button>
    <button
      class="tab-button"
      [class.active]="activeTab === 'discussions'"
      (click)="onTabChange('discussions')"
    >
      <i class="fas fa-comments"></i> Product Discussions
    </button>
  </div>

  <!-- Community Feed Tab -->
  <div *ngIf="activeTab === 'community'" class="community-feed">
    <!-- New Post Creation -->
    <div *ngIf="canCreatePosts()" class="new-post-section">
      <button
        *ngIf="!showNewPostForm"
        class="btn btn-primary create-post-btn"
        (click)="showNewPostForm = true"
      >
        <i class="fas fa-plus"></i> Create New Post
      </button>

      <div *ngIf="showNewPostForm" class="create-post-form">
        <h3>Create a Community Post</h3>
        <form (submit)="createCommunityPost(); $event.preventDefault()">
          <div class="form-group">
            <label>What's on your mind?</label>
            <textarea
              [(ngModel)]="newPostContent"
              name="content"
              class="form-control"
              placeholder="Share your thoughts, experiences, or questions..."
              rows="3"
              required
            ></textarea>
          </div>

          <div class="form-group">
            <label>Caption</label>
            <input
              type="text"
              [(ngModel)]="newPostCaption"
              name="caption"
              class="form-control"
              placeholder="Add a descriptive caption..."
              required
            />
          </div>

          <div class="form-group">
            <label>Image URL (optional)</label>
            <input
              type="url"
              [(ngModel)]="newPostImageUrl"
              name="imageUrl"
              class="form-control"
              placeholder="https://example.com/image.jpg"
            />
          </div>

          <div class="form-actions">
            <button type="submit" class="btn btn-primary">Post</button>
            <button type="button" class="btn btn-secondary" (click)="showNewPostForm = false; resetNewPostForm()">Cancel</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Filter Section -->
    <div class="filter-section">
      <select [(ngModel)]="postTypeFilter" (change)="onPostTypeFilterChange()" class="form-control">
        <option value="">All Posts</option>
        <option value="GENERAL">General</option>
        <option value="PRODUCT_REVIEW">Product Reviews</option>
        <option value="LIFESTYLE">Lifestyle</option>
        <option value="TRENDS">Trends</option>
        <option *ngIf="canAccessAdminFeatures()" value="ADMIN_ANNOUNCEMENT">Announcements</option>
      </select>
    </div>

    <!-- Loading State -->
    <div *ngIf="loading" class="loading-state">
      <div class="spinner"></div>
      <p>Loading community posts...</p>
    </div>

    <!-- Community Posts List -->
    <div *ngIf="!loading" class="posts-list">
      <div *ngIf="communityPosts.length === 0" class="no-posts">
        <i class="fas fa-users"></i>
        <h3>No community posts yet</h3>
        <p>Be the first to share something with the community!</p>
      </div>

      <div *ngFor="let post of communityPosts" class="post-card">
        <div class="post-header">
          <div class="user-info">
            <div class="user-avatar">
              <i class="fas fa-user"></i>
            </div>
            <div class="user-details">
              <span class="username">{{ post.user.email }}</span>
              <span class="user-role" [class]="post.user.role">{{ post.user.role }}</span>
              <span class="post-type">{{ post.postType.replace('_', ' ') }}</span>
            </div>
          </div>
          <div class="post-meta">
            <span class="date">{{ formatDate(post.createdAt) }}</span>
            <button *ngIf="canAccessAdminFeatures() || post.userId === currentUser?.id"
                    class="btn btn-sm btn-outline-danger"
                    (click)="deletePost(post.id)">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        </div>

        <div class="post-content">
          <p>{{ post.content }}</p>
          <div *ngIf="post.imageUrl" class="post-image">
            <img [src]="post.imageUrl" [alt]="post.caption" />
          </div>
          <div class="post-caption">
            <strong>{{ post.caption }}</strong>
          </div>
        </div>

        <div class="post-stats">
          <span><i class="fas fa-heart"></i> {{ post.reactionCount }}</span>
          <span><i class="fas fa-comment"></i> {{ post.commentCount }}</span>
          <span><i class="fas fa-share"></i> {{ post.repostCount }}</span>
        </div>

        <div class="post-actions">
          <button class="btn btn-sm btn-outline-primary" (click)="toggleReaction(post.id)">
            <i class="fas fa-heart"></i> React
          </button>
          <button class="btn btn-sm btn-outline-secondary" (click)="repost(post.id)">
            <i class="fas fa-share"></i> Share
          </button>
          <a [routerLink]="['/community/post', post.id]" class="btn btn-sm btn-outline-info">
            <i class="fas fa-comment"></i> Comment
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- Group Chat Tab -->
  <div *ngIf="activeTab === 'chat'" class="group-chat-tab">
    <app-group-chat></app-group-chat>
  </div>

  <!-- Product Discussions Tab -->
  <div *ngIf="activeTab === 'discussions'" class="product-discussions">
    <!-- Search and Filter Section -->
    <div class="search-filter-section">
      <div class="search-bar">
        <input
          type="text"
          placeholder="Search discussions..."
          [(ngModel)]="searchQuery"
          (keyup.enter)="searchDiscussions()"
          class="form-control"
        />
        <button (click)="searchDiscussions()" class="btn btn-primary">
          <i class="fas fa-search"></i> Search
        </button>
      </div>

      <div class="filter-controls">
        <select
          [(ngModel)]="selectedProductId"
          (change)="onProductFilterChange()"
          class="form-control"
        >
          <option value="">All Products</option>
          <option *ngFor="let product of products" [value]="product.id">
            {{ product.name }}
          </option>
        </select>

        <button (click)="loadAllDiscussions()" class="btn btn-secondary">
          Clear Filters
        </button>
      </div>
    </div>

    <!-- Loading State -->
    <div *ngIf="loading" class="loading-state">
      <div class="spinner"></div>
      <p>Loading discussions...</p>
    </div>

    <!-- Discussions List -->
    <div *ngIf="!loading" class="discussions-list">
      <div *ngIf="discussions.length === 0" class="no-discussions">
        <i class="fas fa-comments"></i>
        <h3>No discussions found</h3>
        <p>Be the first to start a discussion!</p>
      </div>

      <div *ngFor="let discussion of discussions" class="discussion-card">
        <div class="discussion-header">
          <div class="product-info">
            <img
              *ngIf="discussion.product.imageUrl"
              [src]="discussion.product.imageUrl"
              [alt]="discussion.product.name"
              class="product-image"
            />
            <div class="product-details">
              <h3>
                <a [routerLink]="['/products', discussion.product.id]">
                  {{ discussion.product.name }}
                </a>
              </h3>
              <p class="product-price">KSh {{ discussion.product.price }}</p>
            </div>
          </div>

          <div class="discussion-meta">
            <span class="author">{{ discussion.user.email }}</span>
            <span class="date">{{ formatDate(discussion.createdAt) }}</span>
          </div>
        </div>

        <div class="discussion-content">
          <p>{{ discussion.content }}</p>
        </div>

        <div class="discussion-actions">
          <div class="discussion-stats">
            <span class="replies-count">
              <i class="fas fa-reply"></i>
              {{ getTotalReplies(discussion) }} replies
            </span>
          </div>

          <div class="action-buttons">
            <a
              [routerLink]="['/products', discussion.product.id]"
              class="btn btn-outline-primary btn-sm"
            >
              <i class="fas fa-eye"></i> View Discussion
            </a>

            <button
              *ngIf="canAccessAdminFeatures()"
              class="btn btn-outline-danger btn-sm"
            >
              <i class="fas fa-trash"></i> Delete
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>